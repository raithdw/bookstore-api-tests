name: API Automation Tests

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-tests-and-deploy:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # Required for GitHub Pages deploy

    steps:
      # Step 1: Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker (Ubuntu runners already have it)
      - name: Set up Docker
        run: docker --version

      # Step 3: Build Docker image for tests
      - name: Build Docker image
        run: docker build -t bookstore-api-tests .

      # Step 4: Create local target folders for Allure
      - name: Prepare target directories
        run: |
          mkdir -p target/allure-results
          mkdir -p target/allure-maven

      # Step 5: Run tests in Docker and generate Allure report
      - name: Run tests and generate Allure report
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/target:/app/target \
            bookstore-api-tests \
            bash -c "mvn test && mvn allure:report \
              -Dallure.results.directory=/app/target/allure-results \
              -Dallure.report.directory=/app/target/allure-maven"

      # Step 6: Verify report exists
      - name: Verify Allure report
        run: |
          echo "Report contents:"
          ls -la target/allure-maven

      # Step 7: Deploy Allure report to GitHub Pages
      - name: Deploy Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: target/allure-maven  # This folder contains index.html
          keep_files: false                 # Overwrite everything in the branch
          destination_dir: ''               # Deploy to root of gh-pages

      # Step 8: Print report URL in Actions summary
      - name: Allure report link
        run: |
          echo "Allure report: https://raithdw.github.io/bookstore-api-tests/index.html" >> $GITHUB_STEP_SUMMARY